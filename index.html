<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Team CRM – Starry Night Edition</title>
  <!-- Include Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Custom styles for the starry night background and animations -->
  <style>
    /* Starry night background: a fixed photo with subtle darkening to improve contrast */
    body {
      @apply relative min-h-screen overflow-x-hidden text-white;
    }
    /* Use a pseudo element so the image stays behind all content */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("night_sky_background.png");
      background-size: cover;
      background-position: center;
      filter: brightness(0.45) saturate(1.2);
      z-index: -2;
      /* Enable subtle vertical scroll by repeating the image and animating the background position */
      background-repeat: repeat-y;
      animation: scrollBackground 120s linear infinite;
    }
    /* Optional star overlay (small flickering points) */
    .star-overlay {
      pointer-events: none;
    }
    .star-overlay span {
      position: absolute;
      background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 70%);
      border-radius: 50%;
      opacity: 0.8;
      animation: twinkle 4s infinite ease-in-out;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1); }
    }
    /* Keyframes for scrolling the background image vertically */
    @keyframes scrollBackground {
      from { background-position-y: 0%; }
      to { background-position-y: 100%; }
    }
  </style>
</head>
<body>
  <!-- Decorative star overlay -->
  <div class="star-overlay" id="stars"></div>
  <!-- Main container -->
  <div id="app" class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <h1 class="text-center text-3xl font-bold tracking-tight">Sales Team CRM</h1>
    <p class="text-center text-gray-300 text-sm">Prototype visualising team metrics for July&nbsp;1 – Aug&nbsp;31,&nbsp;2025</p>
    <!-- Content will be injected here via JavaScript -->
    <div id="content" class="space-y-6">
      <p class="text-gray-400 text-center">Loading team metrics…</p>
    </div>
    <!-- Notes toggle button and panel -->
    <div id="notesSection" class="hidden">
      <h2 class="text-lg font-semibold mb-2">Notes</h2>
      <ul id="notesList" class="list-disc list-inside text-sm text-white space-y-1"></ul>
    </div>
  </div>
  <script>
  // Dynamically add stars to the overlay for subtle motion
  (function generateStars() {
    const starContainer = document.getElementById('stars');
    const numStars = 40;
    for (let i = 0; i < numStars; i++) {
      const star = document.createElement('span');
      const size = Math.random() * 3 + 1;
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = (Math.random() * 4) + 's';
      starContainer.appendChild(star);
    }
  })();

  // Helper function to animate numeric values
  function animateValue(element, start, end, duration, formatter) {
    const range = end - start;
    const startTime = performance.now();
    function step(currentTime) {
      const progress = Math.min((currentTime - startTime) / duration, 1);
      const value = start + range * progress;
      element.textContent = formatter ? formatter(value) : Math.round(value);
      if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  // Fetch the precomputed metrics and build the UI
  fetch('team_metrics.json')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
      return response.json();
    })
    .then(data => {
      if (!data.kpis || !data.reps) {
        throw new Error('Invalid data format: Missing "kpis" or "reps"');
      }
      const content = document.getElementById('content');
      content.innerHTML = '';
      // Build KPI cards
      const kpiContainer = document.createElement('div');
      kpiContainer.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4';
      // Prepare KPI definitions
      const kpis = [
        {
          label: 'Total Revenue',
          value: data.kpis.totalRevenue,
          formatter: (v) => v.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }),
          icon: function() {
            return `
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
              </svg>`;
          }
        },
        {
          label: 'Total Units',
          value: data.kpis.totalUnits,
          formatter: (v) => Math.round(v).toLocaleString(),
          icon: function() {
            return `
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"/>
              </svg>`;
          }
        },
        {
          label: 'Top Rep (Revenue)',
          value: data.reps.length ? data.reps[0].rep : '—',
          formatter: (v) => v,
          icon: function() {
            return `
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"/>
              </svg>`;
          }
        },
        {
          label: 'Top Rep (TWE)',
          value: data.reps.length ? data.reps.slice().sort((a,b) => b.twe - a.twe)[0].rep : '—',
          formatter: (v) => v,
          icon: function() {
            return `
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 0 1-2.448-2.448 14.9 14.9 0 0 1 .06-.312m-2.24 2.39a4.493 4.493 0 0 0-1.757 4.306 4.493 4.493 0 0 0 4.306-1.758M16.5 9a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"/>
              </svg>`;
          }
        }
      ];
      kpis.forEach(item => {
        const card = document.createElement('div');
        card.className = 'relative overflow-hidden rounded-xl p-4 ring-1 ring-white/20 bg-white/10 backdrop-blur-md shadow-lg';
        // Icon
        const iconWrapper = document.createElement('div');
        iconWrapper.innerHTML = item.icon();
        iconWrapper.className = 'text-amber-300 mb-2';
        // Label
        const label = document.createElement('div');
        label.className = 'text-xs uppercase tracking-wide text-amber-200';
        label.textContent = item.label;
        // Value
        const valueEl = document.createElement('div');
        valueEl.className = 'text-xl font-bold text-white';
        // Insert placeholders and animate later
        if (typeof item.value === 'number') {
          valueEl.textContent = '0';
        } else {
          valueEl.textContent = item.value;
        }
        card.appendChild(iconWrapper);
        card.appendChild(label);
        card.appendChild(valueEl);
        kpiContainer.appendChild(card);
        // Animate numeric values after insertion
        if (typeof item.value === 'number') {
          requestAnimationFrame(() => {
            animateValue(valueEl, 0, item.value, 2000, (val) => item.formatter(Math.floor(val)));
          });
        }
      });
      content.appendChild(kpiContainer);
      // Build the team table
      const tableContainer = document.createElement('div');
      tableContainer.className = 'overflow-x-auto ring-1 ring-white/20 rounded-lg backdrop-blur-md bg-white/10';
      const table = document.createElement('table');
      table.className = 'min-w-full text-sm divide-y divide-white/20';
      // table header
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr>' +
        '<th class="px-3 py-2 text-left font-medium text-amber-200">Rep</th>' +
        '<th class="px-3 py-2 text-right font-medium text-amber-200">Revenue</th>' +
        '<th class="px-3 py-2 text-right font-medium text-amber-200">Units</th>' +
        '<th class="px-3 py-2 text-right font-medium text-amber-200">Avg Ticket</th>' +
        '<th class="px-3 py-2 text-right font-medium text-amber-200">Sales %</th>' +
        '<th class="px-3 py-2 text-right font-medium text-amber-200">Hours</th>' +
        '<th class="px-3 py-2 text-right font-medium text-amber-200">TWE</th>' +
        '</tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      data.reps.forEach((rep, index) => {
        const tr = document.createElement('tr');
        // alternating row shading with hover effect and ensure text is legible
        tr.className = 'hover:bg-white/10 transition-colors text-white';
        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap">${rep.rep}</td>
          <td class="px-3 py-2 whitespace-nowrap text-right">${rep.revenue.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 })}</td>
          <td class="px-3 py-2 whitespace-nowrap text-right">${rep.units.toLocaleString()}</td>
          <td class="px-3 py-2 whitespace-nowrap text-right">${rep.avg_ticket.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 })}</td>
          <td class="px-3 py-2 whitespace-nowrap text-right">${(rep.share_of_sales_pct * 100).toFixed(2)}%</td>
          <td class="px-3 py-2 whitespace-nowrap text-right">${rep.hours_worked.toFixed(2)}</td>
          <td class="px-3 py-2 whitespace-nowrap text-right">${rep.twe.toFixed(5)}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      tableContainer.appendChild(table);
      content.appendChild(tableContainer);
      // Notes
      const notes = data.notes || [];
      if (notes.length) {
        const notesSection = document.getElementById('notesSection');
        const notesList = document.getElementById('notesList');
        // Clear existing notes
        notesList.innerHTML = '';
        notes.forEach(note => {
          const li = document.createElement('li');
          li.textContent = note;
          notesList.appendChild(li);
        });
        // Create toggle button
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'mt-6 text-sm text-amber-300 hover:text-amber-200 underline';
        toggleBtn.textContent = 'Show Notes';
        toggleBtn.addEventListener('click', () => {
          const hidden = notesSection.classList.toggle('hidden');
          toggleBtn.textContent = hidden ? 'Show Notes' : 'Hide Notes';
        });
        content.appendChild(toggleBtn);
        content.appendChild(notesSection);
      }
    })
    .catch((err) => {
      document.getElementById('content').innerHTML = '<p class="text-red-300">Error loading metrics: ' + err.message + '</p>';
    });
  </script>
</body>
</html>
